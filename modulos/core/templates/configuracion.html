{% extends 'base.html' %}

{% block title %}Configuración del sistema{% endblock %}
{% block topbar_title %}Configuración del sistema{% endblock %}

{% block content %}
<div class="container mt-5 mb-5" style="max-width: 600px;">
  <div class="card shadow p-4">
    <h4 class="text-center mb-4"><i class="bi bi-gear-fill me-2"></i>Configuración del Sistema</h4>

    <form id="configForm">
      <div class="mb-3">
        <label for="nombreNegocio" class="form-label"><i class="bi bi-shop me-2"></i>Nombre del Negocio</label>
        <input type="text" class="form-control" id="nombreNegocio" name="NombreNegocio" value="{{ config.get('NombreNegocio', '') }}" required>
      </div>

      <div class="mb-3">
        <label for="logoFile" class="form-label"><i class="bi bi-image me-2"></i>Logo del Negocio</label>
        <input type="file" class="form-control" id="logoFile" accept="image/*">
        <img id="logoPreview" src="{{ config.get('LogoURL', '') }}" alt="Vista previa del logo" class="img-fluid mt-3 border" style="max-height: 150px;">
      </div>

      <div class="mb-3">
        <label for="colorPrincipal" class="form-label"><i class="bi bi-palette me-2"></i>Color Principal</label>
        <input type="color" class="form-control form-control-color" id="colorPrincipal" name="ColorPrincipal" value="{{ config.get('ColorPrincipal', '#0d6efd') }}">
      </div>

      <div class="mb-3">
        <label for="colorFondo" class="form-label"><i class="bi bi-palette2 me-2"></i>Color de Fondo</label>
        <input type="color" class="form-control form-control-color" id="colorFondo" name="ColorFondo" value="{{ config.get('ColorFondo', '#ffffff') }}">
      </div>

      <div id="mensajeProcesando" class="text-center fw-bold" style="color:red; font-size:2rem; display:none;">
        PROCESANDO...
      </div>

      <div class="d-flex justify-content-between">
        <a href="/" class="btn btn-danger"><i class="bi bi-x-circle"></i> Cancelar</a>
        <button type="submit" class="btn btn-success"><i class="bi bi-save"></i> Guardar cambios</button>
      </div>
    </form>
  </div>
</div>

<script>
// ====== MEJORAS (sin eliminar tu lógica original) ====== //
// 1. Cargar configuración mejorada
document.addEventListener('DOMContentLoaded', function() {
  // Priorizar localStorage si existe (para persistencia)
  const savedConfig = JSON.parse(localStorage.getItem('appConfig')) || {};
  
  // Aplicar configuración
  if (savedConfig.NombreNegocio) {
    document.getElementById('nombreNegocio').value = savedConfig.NombreNegocio;
  }
  if (savedConfig.ColorPrincipal) {
    document.getElementById('colorPrincipal').value = savedConfig.ColorPrincipal;
  }
  if (savedConfig.ColorFondo) {
    document.getElementById('colorFondo').value = savedConfig.ColorFondo;
  }
  if (savedConfig.LogoURL) {
    // Verificar si es base64 o URL normal
    if (savedConfig.LogoURL.startsWith('data:')) {
      document.getElementById('logoPreview').src = savedConfig.LogoURL;
    } else if (savedConfig.LogoURL) {
      // Mantener tu lógica original de carga
      document.getElementById('logoPreview').src = "{{ config.get('LogoURL', '') }}" || savedConfig.LogoURL;
    }
  }
});

// 2. Vista previa del logo (optimizada)
document.getElementById('logoFile').addEventListener('change', function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      document.getElementById('logoPreview').src = e.target.result;
      // Guardar preview en localStorage inmediatamente
      const currentConfig = JSON.parse(localStorage.getItem('appConfig')) || {};
      currentConfig.LogoURL = e.target.result;
      localStorage.setItem('appConfig', JSON.stringify(currentConfig));
    };
    reader.readAsDataURL(file);
  }
});

// 3. Guardar configuración (versión mejorada)
document.getElementById('configForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const mensaje = document.getElementById('mensajeProcesando');
  mensaje.style.display = 'block';

  const config = {
    NombreNegocio: this.NombreNegocio.value,
    ColorPrincipal: this.ColorPrincipal.value,
    ColorFondo: this.ColorFondo.value,
    LogoURL: document.getElementById('logoPreview').src
  };

  try {
    // Guardar en localStorage (siempre primero)
    localStorage.setItem('appConfig', JSON.stringify(config));

    // ==== MANTENEMOS TU LÓGICA ORIGINAL DE ENVÍO AL SERVIDOR ==== //
    const logoFile = document.getElementById('logoFile').files[0];
    
    if (logoFile) {
      const reader = new FileReader();
      reader.onloadend = async function() {
        const base64Logo = reader.result.split(',')[1];
        await fetch('{{ config["URLScriptConfig"] }}', {
          method: 'POST',
          body: JSON.stringify({
            clave: 'LogoURL',
            valor: base64Logo,
            tipo: 'imagen'
          })
        });
      };
      reader.readAsDataURL(logoFile);
    }

    // Enviar otros datos (texto)
    await Promise.all([
      fetch('{{ config["URLScriptConfig"] }}', {
        method: 'POST',
        body: JSON.stringify({
          clave: 'NombreNegocio',
          valor: config.NombreNegocio
        })
      }),
      fetch('{{ config["URLScriptConfig"] }}', {
        method: 'POST',
        body: JSON.stringify({
          clave: 'ColorPrincipal',
          valor: config.ColorPrincipal
        })
      }),
      fetch('{{ config["URLScriptConfig"] }}', {
        method: 'POST',
        body: JSON.stringify({
          clave: 'ColorFondo',
          valor: config.ColorFondo
        })
      })
    ]);

    setTimeout(() => { window.location.href = '/'; }, 1200);

  } catch (error) {
    console.error('Error:', error);
    // Mensaje más descriptivo
    alert('Configuración guardada localmente. Error al conectar con el servidor: ' + error.message);
    mensaje.style.display = 'none';
  }
});
</script>
{% endblock %}
