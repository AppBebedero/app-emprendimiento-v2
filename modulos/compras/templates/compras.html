{% extends 'base.html' %}

{% block title %}Registrar Compra{% endblock %}
{% block topbar_title %}Registrar Compra{% endblock %}

{% block content %}
<div class="container mt-4 mb-5" style="max-width: 700px;">
  <div class="card shadow p-4">
    <h4 class="mb-4 text-center">ðŸ§¾ Registrar Compra</h4>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-info" role="alert">
          {% for message in messages %}
            {{ message }}
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="POST" action="/compras">
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label class="form-label">Fecha:</label>
          <input type="date" name="Fecha" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">NÂ° Documento:</label>
          <input type="text" name="N_Documento" class="form-control" required>
        </div>
        <div class="col-12">
          <label class="form-label">Proveedor:
            <button type="button" class="btn btn-sm btn-success ms-2" data-bs-toggle="modal" data-bs-target="#modalProveedor">
              <i class="bi bi-plus-circle"></i>
            </button>
          </label>
          <select name="Proveedor" id="proveedor" class="form-select" required>
            {% for p in proveedores %}
              <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Producto:
            <button type="button" class="btn btn-sm btn-success ms-2" data-bs-toggle="modal" data-bs-target="#modalProducto">
              <i class="bi bi-plus-circle"></i>
            </button>
          </label>
          <select name="Producto" id="producto" class="form-select" required>
            {% for prod in productos %}
              <option value="{{ prod }}">{{ prod }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Cantidad:</label>
          <input type="number" name="Cantidad" class="form-control" step="any" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Precio Unitario:</label>
          <input type="number" name="PrecioUnitario" class="form-control" step="any" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Moneda:</label>
          <input type="text" name="Moneda" class="form-control" value="{{ config.Moneda }}" readonly>
        </div>
        <div class="col-md-6">
          <label class="form-label">Forma de Pago:</label>
          <select name="Forma_Pago" class="form-select" required>
            <option value="Efectivo">Efectivo</option>
            <option value="SINPE">SINPE</option>
            <option value="Tarjeta Cr.">Tarjeta Cr.</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Observaciones:</label>
          <textarea name="Observaciones" class="form-control"></textarea>
        </div>
      </div>

      <div class="d-flex justify-content-between">
        <a href="/" class="btn btn-danger"><i class="bi bi-x-circle"></i> Cancelar</a>
        <button type="submit" class="btn btn-success"><i class="bi bi-save"></i> Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Proveedor -->
<div class="modal fade" id="modalProveedor" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formProveedor">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-person-plus-fill me-2"></i>Nuevo Proveedor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Nombre:</label>
          <input type="text" name="Nombre" class="form-control" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Producto -->
<div class="modal fade" id="modalProducto" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formProducto">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>Nuevo Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Nombre:</label>
          <input type="text" name="Nombre" class="form-control" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Guardar Proveedor
document.getElementById('formProveedor').addEventListener('submit', function(e) {
  e.preventDefault();
  const nombre = this.Nombre.value;
  fetch('/guardar_proveedor', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({Nombre: nombre})
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      const select = document.getElementById('proveedor');
      const option = new Option(nombre, nombre);
      select.add(option);
      select.value = nombre;
      bootstrap.Modal.getInstance(document.getElementById('modalProveedor')).hide();
    } else {
      alert(data.message || 'Error al guardar proveedor');
    }
  });
});

// Guardar Producto
document.getElementById('formProducto').addEventListener('submit', function(e) {
  e.preventDefault();
  const nombre = this.Nombre.value;
  fetch('/guardar_producto', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({Nombre: nombre})
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      const select = document.getElementById('producto');
      const option = new Option(nombre, nombre);
      select.add(option);
      select.value = nombre;
      bootstrap.Modal.getInstance(document.getElementById('modalProducto')).hide();
    } else {
      alert(data.message || 'Error al guardar producto');
    }
  });
});
</script>
{% endblock %}
