{% extends 'base.html' %}
{% block content %}
<div class="card mx-auto my-5" style="max-width:600px;">
  <div class="card-body">
    <h4 class="card-title text-center mb-4">Registrar Compra</h4>
    <form method="POST" id="compraForm">
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">Fecha</label>
          <input type="date" name="Fecha" class="form-control" required>
        </div>
        <div class="col-6">
          <label class="form-label">N° Documento</label>
          <input name="N_Documento" class="form-control" required>
        </div>
      </div>
      <div class="row g-2 mt-3">
        <div class="col-6 input-group">
          <label class="form-label w-100">Proveedor</label>
          <select name="Proveedor" class="form-select" required>
            <option value="">-- Seleccione --</option>
          </select>
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalProveedor">
            <i class="bi bi-plus"></i>
          </button>
        </div>
        <div class="col-6 input-group">
          <label class="form-label w-100">Producto</label>
          <select name="Producto" class="form-select" required>
            <option value="">-- Seleccione --</option>
          </select>
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalProducto">
            <i class="bi bi-plus"></i>
          </button>
        </div>
      </div>
      <div class="row g-2 mt-3">
        <div class="col-4">
          <label class="form-label">Cantidad</label>
          <input id="cantidad" type="number" step="1" min="1" class="form-control" required>
        </div>
        <div class="col-4">
          <label class="form-label">Precio Unitario ¢</label>
          <input id="precioUnitario" type="number" step="0.01" min="0" class="form-control" required>
        </div>
        <div class="col-4">
          <label class="form-label">SubTotal ¢</label>
          <input id="subtotal" type="text" class="form-control" readonly>
        </div>
      </div>
      <div class="row g-2 mt-3">
        <div class="col-6">
          <label class="form-label">IVA (%)</label>
          <select id="iva" class="form-select" required>
            <option value="0.13">13%</option>
            <option value="0.04">4%</option>
            <option value="0">Exento</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">Total ¢</label>
          <input id="total" type="text" class="form-control" readonly>
        </div>
      </div>
      <div class="mb-3 mt-3">
        <label class="form-label">Observaciones</label>
        <textarea name="Observaciones" class="form-control" rows="2"></textarea>
      </div>
      <div class="d-flex justify-content-between">
        <a href="{{ url_for('core.inicio') }}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Guardar Compra</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL NUEVO PROVEEDOR -->
<div class="modal fade" id="modalProveedor" tabindex="-1" aria-labelledby="modalProveedorLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalProveedorLabel">
          <i class="bi bi-person-plus-fill me-2"></i>Nuevo Proveedor
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form id="formNuevoProveedor">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-person-badge me-1"></i>Nombre</label>
            <input type="text" class="form-control" name="nombre" required>
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-telephone me-1"></i>Teléfono</label>
            <input type="text" class="form-control" name="telefono" maxlength="9" pattern="\d{4}-\d{4}" placeholder="0000-0000">
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-envelope me-1"></i>Email</label>
            <input type="email" class="form-control" name="email">
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-person me-1"></i>Contacto</label>
            <input type="text" class="form-control" name="contacto">
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-phone me-1"></i>Celular</label>
            <input type="text" class="form-control" name="celular" maxlength="9" pattern="\d{4}-\d{4}" placeholder="0000-0000">
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-briefcase me-1"></i>Tipo de Negocio</label>
            <select class="form-select" name="tipo_negocio" required>
              <option value="">Seleccionar...</option>
              <option value="Suministros">Suministros</option>
              <option value="Oficina">Oficina</option>
              <option value="Librería">Librería</option>
              <option value="Otros">Otros</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-chat-left-text me-1"></i>Observaciones</label>
            <textarea class="form-control" name="observaciones" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle me-1"></i>Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL NUEVO PRODUCTO -->
<div class="modal fade" id="modalProducto" tabindex="-1" aria-labelledby="modalProductoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="modalProductoLabel">
          <i class="bi bi-box-seam me-2"></i>Nuevo Producto
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form id="formNuevoProducto">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-box me-1"></i>Nombre</label>
            <input type="text" class="form-control" name="nombre" required>
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-archive me-1"></i>Categoría</label>
            <select class="form-select" name="categoria" required>
              <option value="">Seleccionar...</option>
              <option value="Producto Terminado">Producto Terminado</option>
              <option value="Materia Prima">Materia Prima</option>
              <option value="Suministros">Suministros</option>
              <option value="Otros">Otros</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-tags me-1"></i>Unidad</label>
            <select class="form-select" name="unidad" required>
              <option value="">Seleccionar...</option>
              <option value="Unitario">Unitario</option>
              <option value="Paquete">Paquete</option>
              <option value="Caja">Caja</option>
              <option value="Otros">Otros</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="bi bi-chat-left-text me-1"></i>Observaciones</label>
            <textarea class="form-control" name="observaciones" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Cancelar
          </button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle me-1"></i>Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function format¢(v){return '₡'+Number(v).toLocaleString('es-CR', {minimumFractionDigits:2});}

  function recalcular(){
    const qty = parseFloat(document.getElementById('cantidad').value)||0;
    const pu  = parseFloat(document.getElementById('precioUnitario').value)||0;
    const sub = qty*pu;
    document.getElementById('subtotal').value = format¢(sub);
    const iva  = parseFloat(document.getElementById('iva').value);
    const tot  = sub*(1+iva);
    document.getElementById('total').value = format¢(tot);
  }

  document.getElementById('cantidad').addEventListener('input', recalcular);
  document.getElementById('precioUnitario').addEventListener('input', recalcular);
  document.getElementById('iva').addEventListener('change', recalcular);

  // Gestión de proveedores y productos en memoria
  const selectProv = document.querySelector('select[name="Proveedor"]');
  const selectProd = document.querySelector('select[name="Producto"]');

  // Proveedores en memoria
  document.getElementById('formNuevoProveedor').addEventListener('submit', function(e){
    e.preventDefault();
    const nombre = this.nombre.value.trim();
    if(nombre){
      let existe = false;
      for(let i=0; i<selectProv.options.length; i++){
        if(selectProv.options[i].value.toLowerCase() === nombre.toLowerCase()){
          existe = true;
          selectProv.selectedIndex = i;
          break;
        }
      }
      if(!existe){
        let o = new Option(nombre, nombre);
        selectProv.add(o);
        selectProv.value = nombre;
      }
      // Forzar evento change
      selectProv.dispatchEvent(new Event('change'));
    }
    bootstrap.Modal.getInstance(document.getElementById('modalProveedor')).hide();
    this.reset();
  });

  // Productos en memoria
  document.getElementById('formNuevoProducto').addEventListener('submit', function(e){
    e.preventDefault();
    const nombre = this.nombre.value.trim();
    if(nombre){
      let existe = false;
      for(let i=0; i<selectProd.options.length; i++){
        if(selectProd.options[i].value.toLowerCase() === nombre.toLowerCase()){
          existe = true;
          selectProd.selectedIndex = i;
          break;
        }
      }
      if(!existe){
        let o = new Option(nombre, nombre);
        selectProd.add(o);
        selectProd.value = nombre;
      }
      selectProd.dispatchEvent(new Event('change'));
    }
    bootstrap.Modal.getInstance(document.getElementById('modalProducto')).hide();
    this.reset();
  });
</script>
{% endblock %}
