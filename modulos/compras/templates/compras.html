{% extends 'base.html' %}
{% block content %}
<div class="card mx-auto my-5" style="max-width:600px;">
  <div class="card-body">
    <h4 class="card-title text-center mb-4">Registrar Compra</h4>
    <form method="POST" id="compraForm">
      <div class="row g-2">
        <div class="col-6">
          <label class="form-label">Fecha</label>
          <input type="date" name="Fecha" class="form-control" required>
        </div>
        <div class="col-6">
          <label class="form-label">N° Documento</label>
          <input name="N_Documento" class="form-control" required>
        </div>
      </div>
      <div class="row g-2 mt-3">
        <div class="col-6 input-group">
          <label class="form-label w-100">Proveedor</label>
          <select name="Proveedor" class="form-select" required>
            <option value="">-- Seleccione --</option>
          </select>
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalProveedor">
            <i class="bi bi-plus"></i>
          </button>
        </div>
        <div class="col-6 input-group">
          <label class="form-label w-100">Producto</label>
          <select name="Producto" class="form-select" required>
            <option value="">-- Seleccione --</option>
          </select>
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalProducto">
            <i class="bi bi-plus"></i>
          </button>
        </div>
      </div>
      <div class="row g-2 mt-3">
        <div class="col-4">
          <label class="form-label">Cantidad</label>
          <input id="cantidad" type="number" step="1" min="1" class="form-control" required>
        </div>
        <div class="col-4">
          <label class="form-label">Precio Unitario ¢</label>
          <input id="precioUnitario" type="number" step="0.01" min="0" class="form-control" required>
        </div>
        <div class="col-4">
          <label class="form-label">SubTotal ¢</label>
          <input id="subtotal" type="text" class="form-control" readonly>
        </div>
      </div>
      <div class="row g-2 mt-3">
        <div class="col-6">
          <label class="form-label">IVA (%)</label>
          <select id="iva" class="form-select" required>
            <option value="0.13">13%</option>
            <option value="0.04">4%</option>
            <option value="0">Exento</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">Total ¢</label>
          <input id="total" type="text" class="form-control" readonly>
        </div>
      </div>
      <div class="mb-3 mt-3">
        <label class="form-label">Observaciones</label>
        <textarea name="Observaciones" class="form-control" rows="2"></textarea>
      </div>
      <div class="d-flex justify-content-between">
        <a href="{{ url_for('core.inicio') }}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Guardar Compra</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Proveedor -->
<div class="modal fade" id="modalProveedor" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Agregar Proveedor</h5></div>
      <div class="modal-body">
        <input id="newProveedor" type="text" class="form-control" placeholder="Nombre proveedor">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-success" id="btnAddProveedor">Agregar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Producto -->
<div class="modal fade" id="modalProducto" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Agregar Producto</h5></div>
      <div class="modal-body">
        <input id="newProducto" type="text" class="form-control" placeholder="Nombre producto">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-success" id="btnAddProducto">Agregar</button>
      </div>
    </div>
  </div>
</div>

<script>
  function format¢(v){return '₡'+Number(v).toLocaleString('es-CR', {minimumFractionDigits:2});}

  function recalcular(){
    const qty = parseFloat(document.getElementById('cantidad').value)||0;
    const pu  = parseFloat(document.getElementById('precioUnitario').value)||0;
    const sub = qty*pu;
    document.getElementById('subtotal').value = format¢(sub);
    const iva  = parseFloat(document.getElementById('iva').value);
    const tot  = sub*(1+iva);
    document.getElementById('total').value = format¢(tot);
  }

  document.getElementById('cantidad').addEventListener('input', recalcular);
  document.getElementById('precioUnitario').addEventListener('input', recalcular);
  document.getElementById('iva').addEventListener('change', recalcular);

  // Gestión en memoria de proveedores/productos
  const selectProv = document.querySelector('select[name="Proveedor"]');
  const selectProd = document.querySelector('select[name="Producto"]');

  document.getElementById('btnAddProveedor').addEventListener('click', ()=>{
    const name = document.getElementById('newProveedor').value.trim();
    if(name){ let o=new Option(name,name); selectProv.add(o); selectProv.value=name;}
    bootstrap.Modal.getInstance(document.getElementById('modalProveedor')).hide();
  });
  document.getElementById('btnAddProducto').addEventListener('click', ()=>{
    const name = document.getElementById('newProducto').value.trim();
    if(name){ let o=new Option(name,name); selectProd.add(o); selectProd.value=name;}
    bootstrap.Modal.getInstance(document.getElementById('modalProducto')).hide();
  });
</script>
{% endblock %}
